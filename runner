#!/bin/bash

# validate environment
[ -z "$CI_SERVER_URL" ] && echo "need to set CI_SERVER_URL" && exit 1
[ -z "$REGISTRATION_TOKEN" ] && echo "need to set REGISTRATION_TOKEN" && exit 1

CONCURRENCY=${CONCURRENCY:-1}
NAME=$(hostname)

# register
export REGISTER_NON_INTERACTIVE=true

for ((i=1;i<=$CONCURRENCY;i++))
do
  gitlab-runner register --name $NAME-$i --executor docker --docker-image docker:latest --docker-volumes /var/run/docker.sock:/var/run/docker.sock
done

gitlab-runner run --working-directory /home/gitlab-runner
